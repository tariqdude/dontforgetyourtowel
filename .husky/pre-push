#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

branch="$(git branch --show-current)"

if [ "$branch" != "main" ]; then
  echo "✖ Push blocked: you are on '$branch'. This repo only pushes from 'main'." 1>&2
  echo "  Switch: git checkout main" 1>&2
  exit 1
fi

git fetch origin main --quiet

LOCAL="$(git rev-parse main)"
REMOTE="$(git rev-parse origin/main)"
BASE="$(git merge-base main origin/main)"

if [ "$LOCAL" = "$REMOTE" ]; then
  exit 0
fi

if [ "$LOCAL" = "$BASE" ]; then
  echo "✖ Push blocked: local 'main' is behind 'origin/main'." 1>&2
  echo "  Run: git pull --ff-only origin main" 1>&2
  exit 1
fi

echo "✓ pre-push: main is ahead of origin/main (ok)"
