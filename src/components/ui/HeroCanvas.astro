---
import type { HeroSceneVariant } from '../../scripts/createHeroScene';

interface Props {
  className?: string;
  variant?: HeroSceneVariant;
}

const { className = '', variant = 'auto' } = Astro.props;
---

<div
  class={`absolute inset-0 z-0 overflow-hidden ${className}`}
  data-hero-root
  data-hero-variant={variant}
>
  <canvas
    data-hero-canvas
    class="block h-full w-full touch-none select-none outline-none"></canvas>

  <div class="hero-canvas-tint" aria-hidden="true"></div>
</div>

<script>
  import { createHeroScene } from '../../scripts/createHeroScene';

  type Variant = 'auto' | 'neural' | 'city' | 'storm' | 'aurora';
  type WithCleanup = { __heroCleanup?: () => void };

  const cleanupAll = () => {
    document
      .querySelectorAll<HTMLCanvasElement>('canvas[data-hero-canvas]')
      .forEach(canvas => {
        const existing = (canvas as unknown as WithCleanup).__heroCleanup;
        if (existing) {
          existing();
          (canvas as unknown as WithCleanup).__heroCleanup = undefined;
        }
      });
  };

  const mountAll = () => {
    document
      .querySelectorAll<HTMLCanvasElement>('canvas[data-hero-canvas]')
      .forEach(canvas => {
        const root = canvas.closest<HTMLElement>('[data-hero-root]');
        if (!root) return;

        const existing = (canvas as unknown as WithCleanup).__heroCleanup;
        if (existing) existing();

        const variant = (root.dataset.heroVariant || 'auto') as Variant;
        const cleanup = createHeroScene(canvas, { variant });
        (canvas as unknown as WithCleanup).__heroCleanup = cleanup;
      });
  };

  // Initial mount + re-mount on Astro view transitions.
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', mountAll, { once: true });
  } else {
    mountAll();
  }

  window.addEventListener('astro:page-load', mountAll);
  document.addEventListener('astro:before-swap', cleanupAll);

  // Allow external UI (e.g., Hero controls panel) to request a remount
  // when swapping chapters/variants.
  window.addEventListener('hero:remount', mountAll);
</script>

<style>
  /* Optional overlay gradient to ensure text readability */
  .hero-overlay {
    background: radial-gradient(
      circle at center,
      transparent 0%,
      rgba(0, 0, 0, 0.4) 100%
    );
    pointer-events: none;
  }

  .hero-canvas-tint {
    position: absolute;
    inset: 0;
    pointer-events: none;
    background: var(--hero-tint-color, transparent);
    opacity: var(--hero-tint-opacity, 0);
    mix-blend-mode: screen;
  }
</style>
